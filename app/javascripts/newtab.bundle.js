!function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(o,r,function(t){return e[t]}.bind(null,r));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=2)}([function(e,t){Array.prototype.sum=function(){return this.reduce((e,t)=>e+t)},HTMLElement.prototype.addClass=function(e){new RegExp(`^${e}$|^${e} | ${e}$| ${e}( )`,"g").test(this.className)||(this.className=`${this.className} ${e}`.trim())},HTMLElement.prototype.removeClass=function(e){const t=new RegExp(`^${e}$|^${e} | ${e}$| ${e}( )`,"g");this.className=this.className.replace(t,"$1").trim()},HTMLCollection.prototype.toArray=function(){return[...this]},NodeList.prototype.toArray=function(){return[...this]}},,function(e,t,n){"use strict";n.r(t);const o=["debug","info","warning","error"];var r={log_level:"debug",get debug(){return o.indexOf(this.log_level.toLowerCase())<=o.indexOf("debug")?console.debug.bind(window.console,"%cDEBUG:","color: #6c757d"):()=>{}},get info(){return o.indexOf(this.log_level.toLowerCase())<=o.indexOf("info")?console.info.bind(window.console,"%cINFO:","color: #17a2b8"):()=>{}},get warning(){return o.indexOf(this.log_level.toLowerCase())<=o.indexOf("warning")?console.warn.bind(window.console,"%cWARNING:","color: #ffc107"):()=>{}},get error(){return o.indexOf(this.log_level.toLowerCase())<=o.indexOf("error")?console.error.bind(window.error,"%cERROR:","color: #dc3545"):()=>{}}};const a=["origin"],i={get:(e,t)=>{if("origin"===t)return e;let n=void 0;const o=localStorage["puerta:"+t];try{n=o&&JSON.parse(o)}catch(e){return r.error("storage: parse json fail, key: ",t)}return n},set:(e,t,n)=>{if(-1!==a.indexOf(t))return r.error("storage: key can not use",t);const o=JSON.stringify(n);return localStorage["puerta:"+t]=o,e[t]=n,!0}};var s=new Proxy({},i);let l=s.wallpapers;l||(l=window.defaultWallpapers.map(e=>({url:"wallpapers/"+e,active:!0})),s.wallpapers=l),l=l.filter(e=>e.active);const d=l[Math.floor(Math.random()*l.length)];d&&(wall.style.backgroundImage=`url(${d.url})`,wall_ghost.style.backgroundImage=`url(${d.url})`);n(0);const c={_eventPools:[],emit:(e,...t)=>{r.debug("event.emit: "+e,t);const n=c._eventPools.find(t=>t.name===e);if(!n)return r.debug("event.emit: dont hit event "+e);const o=n.handles;setTimeout(()=>{o.forEach(e=>{e(...t)})})},listen:(e,t)=>{const n=c._eventPools.find(t=>t.name===e);if(n)n.handles.push(t);else{const n={name:e,handles:[t]};c._eventPools.push(n)}},removeListen:(e,t,n)=>{const o=c._eventPools.find(t=>t.name===e);if(!o)return"not_found";n.removeAll?o.handles=[]:o.handles=o.handles.filter(t=>t.name!==e)}};var u=c;const p={clickListening:!1};p.click=()=>{p.clickListening||(r.info("listener: click-emit listenning"),p.clickListening=!0,window.document.body.addEventListener("click",e=>{!function e(t,n,o=0){if(!o>3||!t)return;const a=t.getAttribute("click-emit");if(!a)return e(t.parentElement,n,o+1);const i=a.split(":"),s=i[0],l=i.slice(1).join(":");s?u.emit(s,l,{target:t,domEvent:n}):r.error("listener: can not get event name in listener click")}(e.target,e)}))};var g=p;const w={pushState:()=>{r.debug("noter push state: ",notes),port.postMessage({request:"post_notes",data:notes,sender:holder.uuid})},genUniqueNoteId:()=>Date.now().toString(),createNoteObject:e=>{const t={msg:"",x:Math.floor(Math.random()*(holder.w_w-500)),y:Math.floor(Math.random()*(holder.w_h-250)),w:300,h:100,node:s.nodeNumder,type:"nomal",status:"default"};return Object.assign(t,e)},createNoteHtmlElement:e=>{const{id:t,msg:n,x:o,y:r,w:a,h:i,type:s,status:l}=e,d=document.createElement("div");return d.setAttribute("id","noteid-"+t),d.setAttribute("class","note"),d.setAttribute("style",`transform: translate(${o}px, ${r}px)`),d.setAttribute("note-status",l||"default"),d.innerHTML=`\n    <div class="box">\n        <div class="note-controls" move-noteid="${t}">\n            <div class="note-remove" remove-noteid="${t}">&times;</div>\n        </div>\n        <div class="rain-bow">\n            <div mark="${t}:primary"></div>\n            <div mark="${t}:success"></div>\n            <div mark="${t}:danger"></div>\n        </div>\n        <textarea\n            autocomplete="off"\n            autocorrect="off"\n            autocapitalize="off"\n            spellcheck="false"\n            editor-noteid="${t}"\n            style="width:${a}px;height:${i-20}px;"\n        >${n}</textarea>\n    </div>`,d},addNote:e=>{void 0===e.id&&(e.id=w.genUniqueNoteId(),notes.push(e)),r.debug(`add note ${e.id} = ${e.msg}`),window.note_box.appendChild(w.createNoteHtmlElement(e))},render:(e=!0,t=+s.nodeNumder)=>{e&&(note_box.innerHTML=""),notes.filter(e=>t===+e.node).forEach(e=>{w.addNote(e)})},checkAndReplaceCode:e=>{const t=e.value;holder.code_tables.forEach(n=>{const o=new RegExp(n.code),r=t.match(o);if(r){const a=r.slice(1),i=e.selectionStart,s=e.value;let l=n.value;a.forEach(e=>{l=l.replace("$",e)}),e.value=t.replace(o,l);const d=i+e.value.length-s.length;e.setSelectionRange(d,d)}})},removeNote:e=>{if(!e)return console.error("remove note: missing noteId");const t=notes.findIndex(t=>t.id==e);-1!==t&&notes.splice(t,1);const n=window["noteid-"+e];n.parentElement.removeChild(n),w.pushState()},mark:(e,t)=>{const n=notes.find(t=>t.id==e);if(!n)return console.error("mark note: cant find note to mark",e);n.status===t?n.status="default":n.status=t,window["noteid-"+e].setAttribute("note-status",n.status),w.pushState()}};{window.note_box.addEventListener("click",e=>{const{target:t}=e,n=t.getAttribute("remove-noteid"),o=t.getAttribute("mark");if(n)w.removeNote(n);else if(o){const[e,t]=o.split(":");w.mark(e,t)}});let e=!1,t=!1,n=0,o=0;window.note_box.addEventListener("mousedown",r=>{if(3===r.which)return;const{target:a}=r;if(null!==a.getAttribute("editor-noteid")){const t=r.clientX,n=r.clientY,o=+a.getAttribute("editor-noteid"),i=notes.findIndex(e=>e.id==o),s=notes[i];s.x+s.w-t<15&&s.y+s.h-n<15&&(e=o)}if(null!==a.getAttribute("move-noteid")){const e=+a.getAttribute("move-noteid"),i=notes.findIndex(t=>t.id==e);n=r.clientX-notes[i].x,o=r.clientY-notes[i].y,t=e}}),window.addEventListener("mousemove",e=>{if(!1===t)return;e.preventDefault();let r=e.clientX-n,a=e.clientY-o;a<0&&(a=0),a>holder.w_h-20&&(a=holder.w_h-20),r<0&&(r=0),r>holder.w_w-20&&(r=holder.w_w-20),console.log(window["noteid-"+t],"noteid-"+t),window["noteid-"+t]&&(window["noteid-"+t].style.transform=`translate(${r}px, ${a}px)`)}),window.addEventListener("mouseup",r=>{if(!1!==t){const e=r.clientX-n,a=r.clientY-o,i=notes.findIndex(e=>e.id==t);-1!==i&&(notes[i].x=e,notes[i].y=a),t=!1,w.pushState()}else if(!1!==e){const{target:t}=r,n=notes.findIndex(t=>t.id==e),o=window["noteid-"+e].offsetWidth,a=window["noteid-"+e].offsetHeight;-1!==n&&(notes[n].w=o,notes[n].h=a),e=!1,w.pushState()}}),window.note_box.addEventListener("keyup",e=>{const{target:t}=e;if(null!==t.getAttribute("editor-noteid")){const n=+t.getAttribute("editor-noteid"),o=notes.findIndex(e=>e.id==n);"="===e.key&&w.checkAndReplaceCode(t),notes[o].msg=t.value,w.pushState()}}),window.btn_add_note.addEventListener("click",()=>{w.addNote(w.createNoteObject()),w.pushState()}),window.btn_switch_node.addEventListener("click",()=>{let e=+s.nodeNumder||0;e>2?e=0:e++,window.btn_switch_node.innerHTML=e,s.nodeNumder=e,w.pushState(),w.render()})}var m=w;const f={htmlBookmarkBar:window.bookmark_bar,htmlMenu:window.bookmarkContextMenu,createItem:e=>{const{url:t,title:n,children:o}=e;return o?(setTimeout(()=>f.render(e)),""):`\n    <a class="item" href="${t}">\n        <img src="chrome://favicon/${t}">\n        <div class="title">${n}</div>\n    </a>`},createParent:e=>{const t=e.title,n=e.children.map(e=>f.createItem(e)).join(""),o=`${t}-${e.parentId||"root"}`;return`\n    <div class="parent ${s["bookmark:parent:"+o]||"open"}">\n        <div class="parent-header" data-parent-id="${o}">\n            <span class="icon icon-folder"></span>\n            <div class="label">${t}</div>\n        </div>\n        <div class="stopgrap"></div>\n        <div class="parent-childs">${n}</div>\n    </div>`},render:(e,t=!1)=>{t&&(f.htmlBookmarkBar.innerHTML=""),f.htmlBookmarkBar.innerHTML+=f.createParent(e)},toggleOpenParent:e=>{const t="bookmark:parent:"+e,n="close"===s[t]?"open":"close";s[t]=n,document.querySelector(`[data-parent-id="${e}"]`).parentNode.className="parent "+n}};f.htmlBookmarkBar.addEventListener("click",e=>{const{target:t}=e,n=t.getAttribute("data-parent-id")||t.parentNode.getAttribute("data-parent-id");n&&f.toggleOpenParent(n)});var v=f;const h={waveInterval:null,ghostTimeout:null,cmdPress:!1},_=(e,t)=>{wave_click_box.innerHTML=`<div class="wave active" style="transform: translate(${e}px, ${t}px)">\n        <div></div>\n        <div></div>\n        <div></div>\n    </div>`};window.addEventListener("mousedown",e=>{const t=e.clientX,n=e.clientY;_(t,n),h.cmdPress?(clearInterval(h.waveInterval),h.waveInterval=setInterval(()=>{_(t,n)},1900)):clearInterval(h.waveInterval)}),window.addEventListener("keydown",e=>{91!==e.keyCode&&17!==e.keyCode||(h.cmdPress=!0),32!==e.keyCode||h.ghostTimeout||(wall_ghost.className="ghost",h.ghostTimeout=setTimeout(()=>{wall_ghost.className="",h.ghostTimeout=null},700))}),window.addEventListener("keyup",e=>{h.cmdPress=!1});const b={isOpen:!1,render:()=>{const e=window.settings_wallpapers.clientWidth/6-10,t=e*holder.w_h/holder.w_w;if(s.wallpapers.length===window.defaultWallpapers.length)s.wallpapers=[...s.wallpapers,...new Array(5).fill({url:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQYV2M4c+bMfwAIMANkq3cY2wAAAABJRU5ErkJggg=="})];else if(s.wallpapers.length-5!==window.defaultWallpapers.length){let e=s.wallpapers;e=e.filter(e=>e.url.startsWith("data")),e=[...window.defaultWallpapers.map(e=>({url:"wallpapers/"+e,active:!1})),...e],s.wallpapers=e}window.settings_wallpapers.innerHTML=s.wallpapers.map((n,o)=>{let r="settings-wall-pre";n.active&&(r+=" active");let a="";return o>=window.defaultWallpapers.length&&(a+=`<span click-emit="setting_wallpaper_edit:${o}">EDIT</span>`),`\n        <div\n            class="${r}"\n            style="width: ${e}px; height: ${t}px; background-image: url(${n.url})"\n            click-emit="setting_wallpaper_toggle:${o}"\n        >${a}</div>\n        `}).join(""),window.setting_config_input.value=JSON.stringify(config).replace(/,/g,",\n").replace("{","{\n").replace("}","\n}"),window.setting_code_table_input.value=holder.code_tables.map(e=>`${e.code.slice(0,-2)} -> ${e.value}`).join("\n")},toggle:e=>{void 0===e&&(e=!b.isOpen),b.isOpen=e,e?(window.setting_box.removeClass("hidden"),b.render()):window.setting_box.addClass("hidden")}};u.listen("setting_close",()=>{b.toggle(!1)}),u.listen("setting_open",()=>{b.toggle(!0)}),u.listen("setting_backup",()=>{const e=new Date,t={};t.notes=notes,t.storage=JSON.parse(JSON.stringify(localStorage));const n=JSON.stringify(t),o=new Blob([n],{type:"text/plain"});null!==holder.blob_buffer_url&&window.URL.revokeObjectURL(holder.blob_buffer_url),holder.blob_buffer_url=window.URL.createObjectURL(o);const r=document.createElement("a");r.href=holder.blob_buffer_url,r.download="puerta-backup-"+e.toLocaleDateString().replace(/\//g,"-")+".json",r.click()}),u.listen("setting_restore",()=>{const e=document.createElement("input");e.type="file",e.addEventListener("change",()=>{const t=e.files[0],n=new FileReader;n.addEventListener("load",()=>{const e=n.result,t=JSON.parse(e),{notes:o,storage:r}=t;port.postMessage({request:"post_notes",data:o}),Object.keys(r).forEach(e=>{localStorage[e]=r[e]}),alert("Restore complated"),location.reload()}),n.readAsText(t)},{once:!0}),e.click()}),u.listen("setting_config_save",()=>{try{const e=JSON.parse(setting_config_input.value);s.config=e,window.config=e}catch(e){return alert("Parse config error")}alert("Save config success")}),u.listen("setting_wallpaper_toggle",(e,{target:t})=>{e=+e;const n=s.wallpapers,o=-1!==t.className.indexOf("active");o?t.removeClass("active"):t.addClass("active"),n[e].active=!o,s.wallpapers=n}),u.listen("setting_wallpaper_edit",(e,{target:t})=>{e=+e;const n=document.createElement("input");n.type="file",n.addEventListener("change",()=>{const o=n.files[0],r=new FileReader;if(o.size>1048576)return alert("Image must be less than 1 megabytes");r.addEventListener("load",()=>{const n=s.wallpapers;n[e].url=r.result,s.wallpapers=n;t.parentElement.style.backgroundImage=`url(${r.result})`}),r.readAsDataURL(o)},{once:!0}),n.click()}),u.listen("setting_wallpaper_reset",()=>{s.wallpapers=null,location.reload()});window.DEFAULT_CONFIG={log_level:"error"},window.config=s.config||DEFAULT_CONFIG,window.holder={uuid:`${Date.now()}_${Math.random()}`,requset_interval:null,background_not_ready:!0,request_boot_system_delay:1e3,w_w:window.document.documentElement.clientWidth,w_h:window.document.documentElement.clientHeight,code_tables:[{code:"date==",value:(new Date).toLocaleDateString()},{code:"time==",value:(new Date).toLocaleTimeString()},{code:"now==",value:(new Date).toLocaleString()}],blob_buffer_url:null},window.port=chrome.runtime.connect({name:"pip"}),window.notes=[],r.log_level=config.log_level,g.click(),chrome.runtime.onMessage.addListener(e=>{const{request:t,sender:n}=e;switch(r.debug("receive onetime message",e),t){case"note_updated":n===holder.uuid||port.postMessage({request:"get_notes"});break;default:r.error("one time message out of services")}}),port.onMessage.addListener(({request:e,data:t,sender:n,err:o})=>{if(o)return r.error(o);switch(e){case"are_you_ready":t&&(port.postMessage({request:"get_mostsite"}),port.postMessage({request:"get_notes"}),holder.background_not_ready=!1,r.debug("background is ready, request interval cleared"),clearInterval(holder.requset_interval),holder.requset_interval=null);break;case"get_bookmark":v.render(t[0].children[0]);break;case"get_mostsite":v.render({children:t,title:"Most visited"},!0),port.postMessage({request:"get_bookmark"});break;case"get_notes":notes=t.notes||[],r.debug("received notes form backgroud: ",notes),m.render();break;default:r.error("revice response not match")}}),window.addEventListener("resize",()=>{holder.w_w=window.document.documentElement.clientWidth,holder.w_h=window.document.documentElement.clientHeight}),void 0===s.nodeNumder&&(s.nodeNumder=0),window.btn_switch_node.innerHTML=s.nodeNumder,port.postMessage({request:"are_you_ready"}),null===holder.requset_interval&&holder.background_not_ready&&(holder.requset_interval=setInterval(()=>{location.reload()},holder.request_boot_system_delay))}]);